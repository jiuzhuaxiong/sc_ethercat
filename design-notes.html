
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Ethercat Design Notes &mdash; Ethercat  documentation</title>
    <link rel="stylesheet" href="_static/xdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/xcomment.js"></script>
    <link rel="top" title="Ethercat  documentation" href="index.html" />
    <link rel="next" title="Usage" href="usage.html" />
    <link rel="prev" title="Ethercat" href="summary.html" /> 

<script>
function setheight() {
h1 = document.getElementById('d1').style.height;
h2 = document.getElementById('d2').style.height;

if (parseInt(h1) > parseInt(h2)) {
document.getElementById('d2').style.height=h1 + "px";
}
else {
document.getElementById('d1').style.height=h2 + "px";
}

}
</script>
</head>

<body onload="setheight();">

  

    <div class="document" id='d1'>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
<div style="float: right">
<a href="summary.html"
                        title="previous chapter"> &lt&lt </a>
<a href="usage.html"
                        title="next chapter"> &gt&gt </a></p>
</div>

            
  <div class="section" id="ethercat-design-notes">
<h1>Ethercat Design Notes<a class="headerlink" href="#ethercat-design-notes" title="Permalink to this headline">¶</a></h1>
<p>The prototype environment to develop Ethercat is shown below. It comprises
a single L2 motherboard, with 4 ethernet &#8220;slices&#8221;.The bottom left port is
port 0, port 1, 2, and 3 are anticlockwise from there. The XN file included
models that board with all four slices, but missing ports are automatically
skipped.</p>
<div class="figure">
<img alt="_images/photo-4-slices.jpg" src="_images/photo-4-slices.jpg" style="width: 50%;" />
<p class="caption">Photo of prototype ethercat system with 4 ports.</p>
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Ethercat requires a short latency between incoming packet and outgoing
packet. The key to meeting this latency is to use a different design method
then usual for input and output.</p>
<p>Traditionally one would use 32 bit buffered ports to transport data. A port
with this level of buffering creates a 31-bit latency between a bit
arriving and a bit being processed; or 310 ns. Switching to 8 bit ports
creates 70ns latency instead.</p>
<p>A second design criterion is that ports that are switched off should be
bypassed. In our design we are achieving this by rerouting channel ends.
The end of a channel always points to the first active transmit port. This
method enables us to add no latency when skipping ports that are not in
use.</p>
<p>An Ethercat system with N ports requires the following threads:</p>
<ol class="arabic simple">
<li>Data Rx (N)</li>
<li>Data Tx (N).</li>
<li>Frame processing thread (1)</li>
<li>Topology controller (1)</li>
</ol>
</div>
<div class="section" id="data-rx-and-tx">
<h2>Data Rx and Tx<a class="headerlink" href="#data-rx-and-tx" title="Permalink to this headline">¶</a></h2>
<p>Each port has a data receive and transmit thread. The receive thread reads
data of the MII port and outputs it over a streaming channel. The transmit
thread reads data from a streaming channel and outputs this onto the MII
ports. The protocol over the channel comprises unidirectional messages from
Rx to Tx that are always delivered as a whole:</p>
<ol class="arabic simple">
<li>A control token, either CT(3) that means <em>original CRC attached</em> or CT(0)
that means <em>no CRC in this stream, please compute one</em>.</li>
<li>A stream of data bytes comprising the Ethernet frame, including the CRC
if it started with CT(3).</li>
<li>A control token, either CT(0) that means <em>original CRC was valid</em> or
CT(15) that means <em>original CRC was not valid</em></li>
<li>An END control token. This closes the channel, enabling it to be
redirected if required.</li>
</ol>
<p>The RX process will always set the destination of its output channel prior
to transmitting a packet. That means that a whole packet is either
transmitted to the current channel end, or a different one (if the topology
changed). The RX process will always output a 3 token (CRC attached), and
end with 0/15 as appropriate.</p>
<p>The TX process will store the start token, and compute a CRC on the data on
the fly, but, if it gets to the final token it takes one of three
decisions:</p>
<ol class="arabic simple">
<li>The start token was CT(3): we have just outputted the original CRC, and
hence we discard our CRC and stop transmitting; packet complete.</li>
<li>The start token was CT(0) and the end token was CT(0): compute the final
CRC, and transmit it.</li>
<li>The start token was CT(0) and the end token was not CT(0): compute the
final CRC, xor it with the final token (invalidating the CRC), and
transmit the invalid CRC. This guarantees that an invalid CRC on input
results in an invalid CRC on output.</li>
</ol>
</div>
<div class="section" id="frame-processing">
<h2>Frame processing<a class="headerlink" href="#frame-processing" title="Permalink to this headline">¶</a></h2>
<p>Frame processing inputs and outputs the packet with the same channel
protocol, but it replaces the initial &#8216;3&#8217; control token with a &#8216;0&#8217;, and
discards the last 4 btyes of the stream; discarding the CRC, and requesting
the transmitter to compute a new one. This enables the frame processor to
modify the data and implement mailboxes, reads, and writes.</p>
</div>
<div class="section" id="toplogy-controller">
<h2>Toplogy controller<a class="headerlink" href="#toplogy-controller" title="Permalink to this headline">¶</a></h2>
<p>The topology controller inspects, using SMI and INT_N wires, whether the
PHYs are connected to other PHYs. Given the current configuration, it
computes the first connected port for each port, and sets up the
destination for each Rx process. Rx process 0 is always destined to the
frame processor, but the FrameProcessor, Rx1, Rx2, and Rx3, communicate with
whatever Tx is next. Fully populated they would transmit to Tx1, Tx2, Tx3,
and Tx0; but if, say, nothing is plugged into port 2, then they would
communicate with Tx1, Tx3, Null, and Tx0.</p>
<p>This is arranged through an array in some shared memory - the words contain
destination addresses, are written byt he topology controller, and are read
by the Rx/FrameController threads.</p>
</div>
</div>



          </div>
        </div>
      </div>
      <div class="sphinxsidebar" id='d2'>
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">Ethercat</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="summary.html">Ethercat</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Ethercat Design Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-rx-and-tx">Data Rx and Tx</a></li>
<li class="toctree-l2"><a class="reference internal" href="#frame-processing">Frame processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#toplogy-controller">Toplogy controller</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
</ul>

<div id="searchbox" style="display: none;margin-bottom: 10px;">
  <h3>Search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>



    <div class="footer">
    </div>
  </body>
</html>



